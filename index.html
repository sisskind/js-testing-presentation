<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>JavaScript Testing</title>

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/default.css" id="theme">

        <!-- For syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

		<style>#sessions li {border-bottom: 1px solid;}</style>
		
        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = 'css/print/pdf.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

    <div class="reveal">

    <div class="slides">

    <section>

        <h1>JavaScript Testing</h1>
		<img src="img/TesterDeveloper.jpg" >

    </section>

    <section>
	
    <h2>Tools</h2>
    <ul>
    	<li>ESLint</li>
      	<img src="img/eslint.png" >
    	<li>Mocha</li>
      	<img src="img/mocha.png" >
        <li>Cucumber and Capybara</li>
    </ul>
    </section>
	
	<section>
		<section><h2>ESLint</h2></section>
		<section>
			<h2>What is ESLint?</h2>
			<ul>
				<li>ESLint is an open source project with the goal to provide a pluggable linting utility for JavaScript</li>
				<li><a href="eslint.org">ESLint Home Page</a></li>
		</section>
		<section>
			<h3>What does ESLint do?</h3>
			<ul>
				<li>Code linting is a type of static analysis that is used to find problematic patterns or code that doesn't adhere to certain style guidelines, or rules.</li>
				<li>JavaScript does not have a compiler, so JavaScript is typically executed in order to find syntax or other errors.</li>
				<li>ESLint allows developers to discover problems with their JavaScript code without executing it!</li>
				<li>Rules are standalone and can be turned on or off, and set as a warning or error.</li>
			</ul>
		</section>
		<section>
			<h3>How do you run ESLint?</h3>
			<ul>
				<li>ESLint is written using Node.js to provide a fast runtime environment and easy installation via npm.</li>
				<br>
				<li>Installation:
					<pre><code data-trim>
						npm i -g eslint
					</code></pre>
				</li>
				<br>
				<li>Execution:
					<pre><code data-trim>
						eslint file1.js file2.js
					</code></pre>
				</li>
				<br>
				<li>Execution (Directory):
					<pre><code data-trim>
						eslint lib/**
					</code></pre>
				</li>
			</ul>
		</section>
		<section>
			<h3>Examples of Rules</h3>
			<ul>
				<li><a href='http://eslint.org/docs/rules/'>Full List</a></li>
				<li><i>semi-spacing</i>: enforce spacing after semicolons</li>
				<li><i>eqeqeq</i>: require the use of <b>===</b> and <b>!==</b></li>
				<li><i>no-loop-func</i>: disallow <b>function</b> declarations and expressions inside loop statements</li>
			</ul>
		</section>
		<section>
			<h3>ESLint Demo</h3>
			<iframe width='100%' height='600px' frameBorder='0' src='https://eslint.org/demo/'></iframe>
			</br>
			<a href='https://eslint.org/demo/'>ESLint Demo</a>
			</br>
		</section>
    </section>
	
    <section>
    	<section><h2>Mocha</h2></section>
		<section>
			<h2>What is Mocha JS?</h2>
			<ul>
				<li>Mocha is a feature-rich JavaScript test framework running on Node.js and in the browser.</li>
				<li>Mocha tests run serially, allowing for flexible and accurate reporting, while mapping uncaught exceptions to the correct test cases.</li>
				<li><a href="https://mochajs.org/">Mocha JS Home Page</a></li>
		</section>
		<section>
			<h3>How do you run Mocha?</h3>
			<ul>
				<li>Installation:
					<pre><code data-trim>
						npm install -g mocha
					</code></pre>
				</li>
				<br>
				<li>Execution:
					<pre><code data-trim>
						mocha
					</code></pre>
				</li>
				<br>
				<li>
					It is that simple in the context of iD since it comes packaged with preset tests.  For more on how to build from scratch, visit the <a href='https://mochajs.org/#getting-started'>Mocha Home Page</a>
				</li>
			</ul>
		</section>
		<section>
			<h3>Mocha Synchronous Code Example</h3>
			<pre><code data-trim>
			describe('Array', function() {
			  describe('#indexOf()', function() {
			    it('should return -1 when the value is not present', function() {
			      [1,2,3].indexOf(5).should.equal(-1);
			      [1,2,3].indexOf(0).should.equal(-1);
			    });
			  });
			});
			</code></pre>
		</section>
		<section>
			<h3>Mocha Asynchronous Code Example</h3>
			<pre><code data-trim>
			describe('User', function() {
			  describe('#save()', function() {
			    it('should save without error', function(done) {
			      var user = new User('Luna');
			      user.save(function(err) {
			        if (err) throw err;
			        done();
			      });
			    });
			  });
			});
			</code></pre>
		</section>
		<section>
			<h3>Thoughts on Mocha</h3>
			<ul>
				<li>There is going to be the steepest learning curve if you have not done unit testing before, or are new to JavaScript.</li>
				<li>But don't be afraid!  This is a great opportunity to learn not only something new, but a valuable skill for your career!</li>
				<li>The documentation is great, and there are numerous blog posts that will help us all get up to speed moving forward.</li>
		</section>
	</section>    
	<section>
		<section><h2>Cucumber with Capybara</h2></section>
		<section>
			<h2>What is Cucumber and Capybara?</h2>
			<ul>
				<li><a href='https://github.com/cucumber/cucumber-js'>Cucumber</a> is a framework to run behavior driven development (BDD) tests</li>
				<li><a href='http://jnicklas.github.io/capybara/'> Capyabara</a> a is a framework used to simulate a user interacting with a web app</li>
				<li>Cucumber with Capybara is a testing stack primarily written by the Ruby/Rails community, but is not the only option (just the one we use).</li>
		</section>
		<section>
			<h3>What do Cucumber and Capybara test?</h3>
			<ul>
				<li>Cucumber and Capybara test user interactions with the web browser and written code.</li>
			</ul>
		</section>
		<section>
			<h3>How are Cucumber Tests Structured?</h3>
			<ul>
				<li><b><i>Tests</i></b> and <b><i>Steps</i></b> are located in the features directory</li>
				<li>Steps are found in a folder named <b><i>step_definitions</i></b> in a file named <b><i>custom_steps.rb</i></b></li>
				<li>Tests are in the features folder and named with the extension <b><i>.feature</i></b></li>
				<li>A <b><i>support</i></b>directory contains a file named <b><i>env.rb</i></b> which contains configuration information</li>
			</ul>
		</section>	
		<section>
			<h3>How do you run Cucumber?</h3>
			<pre><code data-trim>
			cucumber features/authenticate_user.feature
			</code></pre>
			<br>
			<pre><code data-trim>
			cucumber features/*
			</code></pre>
		</section>
		<section>
				<h3>BDD Ideal Cucumber Scenario</h3>
			    <pre><code data-trim data-noescape>
Feature: Conflate feature with stats

  Scenario: I can conflate the AllDataTypes data
    Given I am on Hootenanny
    And I add the "AllDataTypesACucumber" Reference Dataset
			    </code></pre>
				<ul>
					<li>reads like a use case</li>
					<li>written by a business analyst</li>
					<li>understandable by a user</li>
				</ul>
			</section>
			<section>
				<h4>Cucumber Scenario written by web developers</h4>
			    <pre><code data-trim data-noescape>
Feature: Conflate feature with stats

  Scenario: I can conflate the AllDataTypes data
    Given I am on Hootenanny
    And I resize the window
    And I click Get Started
    And I press "Add Reference Dataset"
    And I click the "AllDataTypesACucumber" Dataset
    And I press "Add Layer"
    Then I wait 30 "seconds" to see "AllDataTypesACucumber"
			    </code></pre>
				<ul>
					<li>more granular</li>
					<li>step-by-step buttonology</li>
					<li>but probably still acceptable</li>
				</ul>
			</section>
			<section>
				<h4>Cucumber Scenario gone off the rails</h4>
			    <pre><code data-trim data-noescape>
    Scenario: Filter Bookmarks
        Then I select the "sprocket" div
        And I click on the "Review Bookmarks" option in
        	the "settingsSidebar"
        Then I select the "reviewBookmarksFilterByMapIdDiv" div
        Then I click the "mergedBookmarkTest" link
        	under "reviewBookmarksFilterByMapIdDiv"
			    </code></pre>
				<ul>
					<li>css details leaking up into the steps</li>
					<li>impossible to write or understand without using the UI inspector</li>
					<li>we know we're doing it wrong...</li>
					<li>...but we'll get better</li>
				</ul>
			</section>
			<section>
				<h4>Implementing a custom step with Capybara</h4>
				<p>Step:</p>
			    <pre><code data-trim data-noescape>
And I select the "File (osm)" option in
	the "Select Import Type" combobox
			    </code></pre>
				<p>Definition:</p>
			    <pre><code data-trim data-noescape>
When(/^I select the "([^"]*)" option in the "([^"]*)" combobox$/)
	do |opt, cb|
  combobox = page.find(:css, 'input[placeholder="' + cb + '"]')
  combobox.find(:xpath, '..').find('.combobox-caret').click
  page.find('div.combobox').find('a', :text=> opt).click
end
			    </code></pre>
			</section>
			<section>
				<h4>Another Example</h4>
				<p>You can use Ruby code in the step definition</p>
				<p>Step:</p>
			    <pre><code data-trim data-noescape>
    Then the download file "export_conflated.zip" should exist
			    </code></pre>
				<p>Definition:</p>
			    <pre><code data-trim data-noescape>
Then(/^the download file "([^"]*)" should exist$/) do |file|
  name = ENV['HOME'] + '/Downloads/' + file
  expect( File.exists?(name) ).to be true
  File.delete(name)
end
			    </code></pre>
			</section>
			<section>
				<h4>Cucumber in Action!</h4>
			    <img src="img/cucumber.gif" >
			</section>
			<section>
				<h4>Successful Step</h4>
			    <img src="img/success.png" >
			</section>
			<section>
				<h4>Unsuccessful Step</h4>
			    <img src="img/error.png" >
			    <br>
			    <ul>
			    	<li>If included, the screenshot plugin will capture UI at points of test failure.</li>
			      	<li>Currently included in Vagrant build of Hootenanny.</li>
			      </ul>
			</section>
			<section>
				<h4>Missing Step</h4>
			    <img src="img/nostep-1.png" >
			    <img src="img/nostep-2.png" >
			</section>
    </section>
    <section>
    	<section><h2>Running Tests on MapEdit and Hootenanny</h2></section>
    	<section>
    		<h3>MapEdit</h3>
    		<pre><code data-trim>
$: ~/mapedit-id$ npm test
iD@1.8.5 test /home/jsisskind/mapedit-id
eslint js/id && mocha-phantomjs test/index.html --ssl-protocol=tlsv1 && make && mocha-phantomjs test/index_packaged.html --ssl-protocol=tlsv1
			</code></pre>
			<br>
			<h4>This runs the entire node test suite, including eslint and mocha (with phantomJS).</h4>
		</section>
		<section>
		<h3>Result</h3>
			<pre><code data-trim>
/home/jsisskind/mapedit-id/js/id/actions/change_preset.js
10:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs				  
11:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
12:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
13:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
13:11  error  Unexpected console statement                  no-console
14:17  error  Unexpected console statement                  no-console
15:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
16:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
17:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
18:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
18:11  error  ["source"] is better written in dot notation  dot-notation
20:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
22:2   error  Mixed spaces and tabs                         no-mixed-spaces-and-tabs
24:10  error  Unnecessary semicolon                         no-extra-semi

/home/jsisskind/mapedit-id/js/id/id.js
1:20  error  Strings must use singlequote  quotes
2:18  error  Strings must use singlequote  quotes

/home/jsisskind/mapedit-id/js/id/renderer/geojson_layer.js
19:13   error  Strings must use singlequote  quotes
19:48   error  Strings must use singlequote  quotes
20:13   error  Strings must use singlequote  quotes
20:56   error  Strings must use singlequote  quotes
21:13   error  Strings must use singlequote  quotes
21:54   error  Strings must use singlequote  quotes
22:13   error  Strings must use singlequote  quotes
22:68   error  Strings must use singlequote  quotes
23:13   error  Strings must use singlequote  quotes
23:69   error  Strings must use singlequote  quotes
23:110  error  Strings must use singlequote  quotes
24:13   error  Strings must use singlequote  quotes
24:55   error  Strings must use singlequote  quotes
24:78   error  Strings must use singlequote  quotes
131:50   error  Missing semicolon             semi

/home/jsisskind/mapedit-id/js/id/services/taginfo.js
113:43  error  Expected '===' and instead saw '=='  eqeqeq
113:45  error  Strings must use singlequote         quotes
122:50  error  Strings must use singlequote         quotes
122:64  error  Strings must use singlequote         quotes
125:95  error  Missing semicolon                    semi
126:67  error  Strings must use singlequote         quotes

/home/jsisskind/mapedit-id/js/id/ui/dgcarousel.js
245:55  error  Strings must use singlequote  quotes

âœ– 38 problems (38 errors, 0 warnings)

npm ERR! Test failed.  See above for more details.
    		</code></pre>
		</section>
		<section>
		<h3>Hootenanny</h3>
		<pre><code data-trime>make test</code></pre>
		<br>
		<pre><code data-trim>xvfb-run --server-args="-screen 0, 1024x768x24" cucumber --format pretty --strict features/osm_tds_switcher.feature</code></pre>
		</section>
    </section>
    <section>
    	<h2>What's Next?</h2>
    	<ul>
    		<li>Requirement to meet 80% code coverage.</li>
    		<li>For Hootenanny, we use Istanbul for code coverage, but we can focus on that later.</li>
    		<li>Also need to run nightly tests to ensure (a) tests are running properly, and (b) new code does not break previously working tests.</li>
    	</ul>
    </section>
    <section><h2>Questions?</h2></section>

    <!-- end slides -->
    </div>

    <!-- end reveal container -->
    </div>

    <!-- Scripts below -->

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
